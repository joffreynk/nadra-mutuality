generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Organization {
  id               String            @id @default(cuid())
  name             String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  users            User[]
  members          Member[]
  companies        Company[]
  invoices         Invoice[]
  auditLogs        AuditLog[]
  documents        Document[]
  systemSetting    SystemSetting?
  categories       Category[]
  treatments       Treatment[]
  pharmacyRequestReceipts PharmacyRequestReceipt[]
  pharmacyRequests PharmacyRequest[]

}

enum RoleType {
  HEALTH_OWNER
  WORKER
  PHARMACY
  HOSPITAL
}

model User {
  id             String        @id @default(cuid())
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  email          String        @unique
  username       String        @unique
  name           String
  passwordHash   String
  role           RoleType      @default(WORKER)
  failedLogins   Int           @default(0)
  isLocked       Boolean       @default(false)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  accounts       Account[]
  sessions       Session[]
  auditLogs      AuditLog[]
  pharmacyAprovers  PharmacyRequestItem[]
  receiptCreators PharmacyRequestReceipt[]
  hospitalPharmacyCreators PharmacyRequest[]
  hospitaltreaments Treatment[]
  
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Member {
  id               String            @id @default(cuid())
  organizationId   String
  categoryID       String
  category         Category          @relation(fields: [categoryID], references: [id])
  organization     Organization      @relation(fields: [organizationId], references: [id])
  memberCode       String            @unique
  name             String
  dob              DateTime?
  contact          String?
  email            String?
  address          String?
  idNumber         String?
  passportPhotoUrl String?
  isDependent      Boolean           @default(false)
  familyRelationship     String?
  gender           String?
  country          String?
  companyId        String?
  company          Company?          @relation(fields: [companyId], references: [id])
  status           String            @default("Active")
  invoices         Invoice[]
  endOfSubscription DateTime @default(dbgenerated("DATE_ADD(NOW(), INTERVAL 6 MONTH)"))
  treatments       Treatment[]
  Pharmacysrequests PharmacyRequest[]
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  deletedAt        DateTime?

  @@index([organizationId])
}

model Invoice {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  memberId       String?
  member         Member?      @relation(fields: [memberId], references: [id])
  period         Int
  amount         Decimal      @db.Decimal(10, 2)
  status         String       @default("Pending")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model Company {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  name           String
  phoneNumber    String?
  email          String?
  address        String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  members        Member[]
}

model AuditLog {
  id             String        @id @default(cuid())
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  userId         String?
  user           User?         @relation(fields: [userId], references: [id])
  action         String
  entityType     String
  entityId       String
  before         Json?
  after          Json?
  ipAddress      String?
  userAgent      String?
  reason         String?
  createdAt      DateTime      @default(now())
}

model Document {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  ownerType      String
  ownerId        String
  filename       String
  mimeType       String
  size           Int
  url            String // Changed from cloudinaryId to url
  createdAt      DateTime     @default(now())
}

model SystemSetting {
  id                     String       @id @default(cuid())
  organizationId         String       @unique
  organization           Organization @relation(fields: [organizationId], references: [id])
  systemName             String       @default("Nadra Healthcare Insurance")
  location              String?      
  phoneNumber           String?
  email                  String?
  logo                   String?
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt
}

model Category {
  id              String       @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id])
  name            String
  coveragePercent Int          @default(80)
  price           Decimal?     @db.Decimal(10, 2)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  members Member[]

  @@unique([name])
  @@index([organizationId])
}


model Treatment {
  id                   String          @id @default(cuid())
  organizationId       String
  code String @unique
  organization         Organization    @relation(fields: [organizationId], references: [id])
  memberId             String
  member               Member          @relation(fields: [memberId], references: [id])
  receiptUrl           String? // Changed from receiptCloudinaryId to receiptUrl
  treatments                TreatmentItem[]
  usercreator       String
  user         User     @relation(fields: [usercreator], references: [id], onDelete: Cascade)
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  tcode PharmacyRequest?
}

model TreatmentItem {
  id                String           @id @default(cuid())
  treatmentId       String
  treatment         Treatment        @relation(fields: [treatmentId], references: [id])
  treatmentName     String
  quantity          Int              @default(1)
  unitPrice         Decimal         @db.Decimal(10, 2)
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
}



model PharmacyRequest {
  id                   String          @id @default(cuid())
  organizationId       String
  organization         Organization    @relation(fields: [organizationId], references: [id])
  memberId             String
  member               Member          @relation(fields: [memberId], references: [id])
  code String @unique
  tcodes Treatment @relation(fields: [code], references:[code])
  usercreator       String
  user         User     @relation(fields: [usercreator], references: [id], onDelete: Cascade)
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  pharmacyRequests PharmacyRequestItem[]
  pharmacyRequestReceipts PharmacyRequestReceipt[]
}

model PharmacyRequestItem {
  id                String           @id @default(cuid())
  mdecineName       String
  quantity          Int              @default(1)
  unitPrice         Decimal?         @db.Decimal(10, 2)
  status         String       @default("Pending")
  pharmacyRequestId      String
  pharmacyRequest         PharmacyRequest        @relation(fields: [pharmacyRequestId], references: [id])
  userAproverId       String?
  user         User?     @relation(fields: [userAproverId], references: [id], onDelete: Cascade)
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
}

model PharmacyRequestReceipt{
  id                String           @id @default(cuid())
  organizationId       String
  organization         Organization    @relation(fields: [organizationId], references: [id])
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  pharmacyRequestId      String
  pharmacyRequest         PharmacyRequest        @relation(fields: [pharmacyRequestId], references: [id])
  url String
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  @@unique([userId, pharmacyRequestId])
}